---
import Layout from "../layouts/Layout.astro";
import HiringNotice from "../components/HiringNotice.astro";
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { projects, type Project } from "../data/projects";

// Load GitHub repos directly at build time
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const reposPath = join(__dirname, '../../public/data/pinned-repos.json');
const githubRepos = JSON.parse(readFileSync(reposPath, 'utf-8')).slice(0, 6);

// Fetch star counts for open source projects
async function getStarCount(owner: string, repo: string): Promise<number> {
    try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
            headers: {
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'nijaru-portfolio'
            }
        });
        if (!response.ok) return 0;
        const data = await response.json();
        return data.stargazers_count || 0;
    } catch {
        return 0;
    }
}

// Populate stars for all projects that have a repo
for (const project of projects) {
    if (project.repo) {
        project.stars = await getStarCount(project.repo.owner, project.repo.name);
    }
}

// Helper to categorize projects
const recentProjects = projects.filter(p => p.category === 'Recent');
const otherProjects = projects.filter(p => p.category === 'Other');
---

<Layout 
    title="Projects - Nick Russo" 
    description="Explore Nick Russo's open source projects including vector databases in Mojo, TUI coding agents in Rust, and AI infrastructure experiments."
>
    <!-- Hero Section -->
    <section class="section-lg">
        <div class="container container-md">
            <div class="text-center">
                <h1 class="heading-1">
                    <span class="text-accent-blue">Projects</span>
                </h1>
                <p class="body-large text-text-secondary max-w-2xl mx-auto">
                    Building databases, AI tools, and developer infrastructure
                </p>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Featured Repositories -->
    <section class="section">
        <div class="container container-sm">
            <div class="content-bg-subtle">
                <div class="text-center mb-12">
                    <h2 class="heading-2">Featured Repositories</h2>
                    <p class="body-normal text-text-secondary">
                        Live projects from GitHub with star counts
                    </p>
                </div>

                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {githubRepos.map((repo: any) => (
                    <div class="group">
                        <a
                            href={repo.html_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="block"
                        >
                            <h3 class="text-lg font-medium text-text-primary group-hover:text-accent-blue transition-colors mb-2">
                                {repo.name}
                            </h3>
                            <p class="body-normal text-text-secondary mb-3">
                                {repo.description || "No description available"}
                            </p>
                            <div class="flex items-center gap-4 body-small text-text-tertiary">
                                {repo.language && <span>{repo.language}</span>}
                                <span>★ {repo.stargazers_count || 0}</span>
                            </div>
                        </a>
                    </div>
                ))}
                </div>

                <div class="text-center mt-12">
                    <a
                        href="https://github.com/nijaru"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="btn btn-secondary"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                                clip-rule="evenodd">
                            </path>
                        </svg>
                        View All Projects on GitHub
                    </a>
                </div>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Recent Projects -->
    <section class="section">
        <div class="container container-sm">
            <div class="content-bg-subtle">
                <div class="text-center mb-12">
                    <h2 class="heading-2">Recent Projects</h2>
                    <p class="body-normal text-text-secondary">
                        Latest work and active development
                    </p>
                </div>

                <div class="space-y-8">
                {recentProjects.map(project => (
                    <div class="border-b pb-8" style="border-color: var(--color-border-subtle);">
                        {project.url ? (
                            <a
                                href={project.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="clickable-item group"
                            >
                                <h3 class="heading-3 mb-2 text-text-primary group-hover:underline">
                                    {project.name}
                                </h3>
                                <p class="text-sm mb-4" style={`color: ${project.status === 'Stable' ? '#22c55e' : 'var(--color-accent-primary)'};`}>{project.status}</p>
                                <p class="body-normal text-text-secondary leading-relaxed mb-4">
                                    {project.description}
                                </p>
                                <div class="flex items-center gap-3">
                                    {project.tech.map((t, i) => (
                                        <>
                                            <span class="body-small text-text-tertiary">{t}</span>
                                            {i < project.tech.length - 1 && <span class="body-small text-text-tertiary">•</span>}
                                        </>
                                    ))}
                                    {project.stars !== undefined && project.stars > 0 && (
                                        <>
                                            <span class="body-small text-text-tertiary">•</span>
                                            <span class="body-small text-text-tertiary">★ {project.stars}</span>
                                        </>
                                    )}
                                </div>
                            </a>
                        ) : (
                            <div class="clickable-item cursor-default">
                                <h3 class="heading-3 mb-2 text-text-primary">
                                    {project.name}
                                </h3>
                                <p class="text-sm mb-4" style={`color: ${project.status === 'Stable' ? '#22c55e' : 'var(--color-accent-primary)'};`}>{project.status}</p>
                                <p class="body-normal text-text-secondary leading-relaxed mb-4">
                                    {project.description}
                                </p>
                                <div class="flex items-center gap-3">
                                    {project.tech.map((t, i) => (
                                        <>
                                            <span class="body-small text-text-tertiary">{t}</span>
                                            {i < project.tech.length - 1 && <span class="body-small text-text-tertiary">•</span>}
                                        </>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                ))}
                </div>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Other Projects -->
    <section class="section">
        <div class="container container-sm">
            <div class="content-bg-subtle">
                <div class="text-center mb-12">
                    <h2 class="heading-2">Other Projects</h2>
                    <p class="body-normal text-text-secondary">
                        Additional work and experiments
                    </p>
                </div>

                <div class="space-y-8">
                {otherProjects.map(project => (
                    <div class="border-b pb-8" style="border-color: var(--color-border-subtle);">
                        <a
                            href={project.url || '#'}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="clickable-item group"
                        >
                            <h3 class="heading-3 mb-2 text-text-primary group-hover:underline">
                                {project.name}
                            </h3>
                            <p class="text-sm mb-4" style={`color: ${project.status === 'Stable' ? '#22c55e' : 'var(--color-accent-primary)'};`}>{project.status}</p>
                            <p class="body-normal text-text-secondary leading-relaxed mb-4">
                                {project.description}
                            </p>
                            <div class="flex items-center gap-3">
                                {project.tech.map((t, i) => (
                                    <>
                                        <span class="body-small text-text-tertiary">{t}</span>
                                        {i < project.tech.length - 1 && <span class="body-small text-text-tertiary">•</span>}
                                    </>
                                ))}
                                {project.stars !== undefined && project.stars > 0 && (
                                    <>
                                        <span class="body-small text-text-tertiary">•</span>
                                        <span class="body-small text-text-tertiary">★ {project.stars}</span>
                                    </>
                                )}
                            </div>
                        </a>
                    </div>
                ))}
                </div>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Hiring Notice -->
    <section class="section-sm">
        <div class="container container-md">
            <HiringNotice />
        </div>
    </section>

    <div class="divider"></div>

    <!-- Navigation -->
    <section class="section-sm">
        <div class="container container-md">
            <div class="text-center">
                <a href="/" class="btn btn-secondary link-arrow">
                    Back to Home
                </a>
            </div>
        </div>
    </section>
</Layout>
