---
import Layout from "../layouts/Layout.astro";
import HiringNotice from "../components/HiringNotice.astro";
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { projects } from "../data/projects";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const reposPath = join(__dirname, '../../public/data/pinned-repos.json');
const githubRepos = JSON.parse(readFileSync(reposPath, 'utf-8')).slice(0, 6);

// Fetch star counts for open source projects
async function getStarCount(owner: string, repo: string): Promise<number> {
    if (import.meta.env.DEV) return 100; // Mock in dev

    try {
        const headers: HeadersInit = {
            'Accept': 'application/vnd.github.v3+json',
            'User-Agent': 'nijaru-portfolio'
        };

        if (import.meta.env.GITHUB_TOKEN) {
            headers['Authorization'] = `token ${import.meta.env.GITHUB_TOKEN}`;
        }

        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
            headers,
            signal: AbortSignal.timeout(2000)
        });

        if (!response.ok) return 0;

        const data = await response.json();
        return data.stargazers_count || 0;
    } catch {
        return 0;
    }
}

// Populate stars for all projects that have a repo
await Promise.all(
    projects.map(async (project) => {
        if (project.repo) {
            project.stars = await getStarCount(project.repo.owner, project.repo.name);
        }
    })
);

// Helper to categorize projects
const recentProjects = projects.filter(p => p.category === 'Recent');
const otherProjects = projects.filter(p => p.category === 'Other');
---

<Layout 
    title="Projects - Nick Russo" 
    description="Explore Nick Russo's open source projects including vector databases in Mojo, TUI coding agents in Rust, and AI infrastructure experiments."
>
    <div class="container container-sm pt-32 pb-16">
        <!-- Hero Section -->
        <section class="mb-16 text-center">
            <h1 class="heading-1 mb-6">
                <span class="text-accent-primary">Projects</span>
            </h1>
            <p class="body-large text-text-secondary max-w-2xl mx-auto">
                Building databases, AI tools, and developer infrastructure
            </p>
        </section>

        <div class="divider my-16"></div>

        <!-- Featured Repositories -->
        <section class="mb-20">
            <h2 class="text-2xl font-semibold text-text-primary mb-8 text-center">Featured Repositories</h2>
            <p class="body-normal text-text-secondary text-center mb-12">
                Live projects from GitHub with star counts
            </p>

            <div class="grid gap-6 md:grid-cols-2">
                {githubRepos.map((repo: any) => (
                    <a
                        href={repo.html_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="glass-panel glass-panel-interactive p-6 group block"
                    >
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-semibold text-text-primary group-hover:text-accent-primary transition-colors">
                                {repo.name}
                            </h3>
                            <div class="flex items-center gap-1 text-sm text-text-tertiary">
                                <span>★</span>
                                <span>{repo.stargazers_count || 0}</span>
                            </div>
                        </div>
                        <p class="text-text-secondary text-sm leading-relaxed mb-4 h-10 line-clamp-2">
                            {repo.description || "No description available"}
                        </p>
                        <div class="flex items-center gap-3 text-xs text-text-tertiary">
                            {repo.language && <span class="px-2 py-1 rounded-md bg-white/5">{repo.language}</span>}
                        </div>
                    </a>
                ))}
            </div>

            <div class="text-center mt-12">
                <a
                    href="https://github.com/nijaru"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn btn-secondary"
                >
                    <svg
                        class="w-5 h-5"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                            clip-rule="evenodd">
                        </path>
                    </svg>
                    View All Projects on GitHub
                </a>
            </div>
        </section>

        <div class="divider my-16"></div>

        <!-- Recent Projects -->
        <section class="mb-20">
            <h2 class="text-2xl font-semibold text-text-primary mb-8 text-center">Recent Projects</h2>
            <p class="body-normal text-text-secondary text-center mb-12">
                Latest work and active development
            </p>

            <div class="space-y-12 content-bg-subtle">
                {recentProjects.map(project => (
                    <div class="group">
                        {project.url ? (
                            <a href={project.url} target="_blank" rel="noopener noreferrer" class="block">
                                <div class="flex flex-col md:flex-row md:items-baseline gap-2 mb-3">
                                    <h3 class="text-xl font-semibold text-text-primary group-hover:text-accent-primary transition-colors">
                                        {project.name}
                                    </h3>
                                    <span class={`text-xs px-2 py-0.5 rounded-full border ${project.status === 'Stable' ? 'text-green-400 border-green-400/20 bg-green-400/10' : 'text-blue-400 border-blue-400/20 bg-blue-400/10'}`}>
                                        {project.status}
                                    </span>
                                </div>
                                <p class="text-text-secondary leading-relaxed mb-4 max-w-3xl">
                                    {project.description}
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    {project.tech.map(t => (
                                        <span class="text-xs text-text-tertiary px-2 py-1 rounded bg-white/5">{t}</span>
                                    ))}
                                    {project.stars !== undefined && project.stars > 0 && (
                                        <span class="text-xs text-text-tertiary px-2 py-1 rounded bg-white/5">★ {project.stars}</span>
                                    )}
                                </div>
                            </a>
                        ) : (
                            <div class="block">
                                <div class="flex flex-col md:flex-row md:items-baseline gap-2 mb-3">
                                    <h3 class="text-xl font-semibold text-text-primary">
                                        {project.name}
                                    </h3>
                                    <span class={`text-xs px-2 py-0.5 rounded-full border ${project.status === 'Stable' ? 'text-green-400 border-green-400/20 bg-green-400/10' : 'text-blue-400 border-blue-400/20 bg-blue-400/10'}`}>
                                        {project.status}
                                    </span>
                                </div>
                                <p class="text-text-secondary leading-relaxed mb-4 max-w-3xl">
                                    {project.description}
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    {project.tech.map(t => (
                                        <span class="text-xs text-text-tertiary px-2 py-1 rounded bg-white/5">{t}</span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </section>

        <div class="divider my-16"></div>

        <!-- Other Projects -->
        <section class="mb-20">
            <h2 class="text-2xl font-semibold text-text-primary mb-8 text-center">Other Projects</h2>
            <p class="body-normal text-text-secondary text-center mb-12">
                Additional work and experiments
            </p>

            <div class="space-y-8 content-bg-subtle">
                {otherProjects.map(project => (
                    <a href={project.url || '#'} target="_blank" rel="noopener noreferrer" class="block group hover:bg-white/5 -mx-6 p-6 rounded-2xl transition-colors border border-transparent hover:border-white/5">
                        <div class="flex flex-col md:flex-row md:items-baseline gap-2 mb-2">
                            <h3 class="text-lg font-medium text-text-primary group-hover:text-accent-primary transition-colors">
                                {project.name}
                            </h3>
                            <span class={`text-xs ${project.status === 'Stable' ? 'text-green-400' : 'text-blue-400'}`}>
                                {project.status}
                            </span>
                        </div>
                        <p class="text-text-secondary text-sm leading-relaxed mb-3">
                            {project.description}
                        </p>
                        <div class="flex items-center gap-3 text-xs text-text-tertiary">
                            {project.tech.join(" • ")}
                        </div>
                    </a>
                ))}
            </div>
        </section>

        <div class="divider my-16"></div>

        <!-- Hiring Notice -->
        <section class="mb-16">
            <HiringNotice />
        </section>

        <!-- Navigation -->
        <section class="text-center">
            <a href="/" class="btn btn-ghost link-arrow">
                Back to Home
            </a>
        </section>
    </div>
</Layout>
