---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

// Get all blog posts from the collection
const blogEntries = await getCollection("blog", ({ data }) => {
    // Filter out draft posts in production
    return import.meta.env.PROD ? !data.draft : true;
});

// Calculate reading time
function calculateReadingTime(text) {
    const wordsPerMinute = 200;
    const words = text.trim().split(/\s+/).length;
    const minutes = Math.ceil(words / wordsPerMinute);
    return `${minutes} min read`;
}

// Format and prepare post data
const posts = await Promise.all(
    blogEntries.map(async (post) => {
        // Format the date for display
        const formattedDate = post.data.pubDate.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
        });

        // Get the post body for reading time calculation
        const readingTime = calculateReadingTime(post.body);

        return {
            url: `/blog/${post.slug}`,
            title: post.data.title,
            pubDate: post.data.pubDate,
            formattedDate: formattedDate,
            excerpt: post.data.description,
            tags: post.data.tags,
            readingTime: readingTime,
        };
    })
);

// Sort posts by date (newest first)
posts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());
---

<Layout 
    title="Blog - Nick Russo" 
    description="Thoughts on software development, AI-assisted programming, and technology. Read Nick Russo's insights on building modern software."
>
    <!-- Hero Section -->
    <section class="section-lg">
        <div class="container container-md">
            <div class="text-center">
                <h1 class="heading-1">
                    <span class="text-accent-blue">Blog</span>
                </h1>
                <p class="body-large text-text-secondary max-w-2xl mx-auto">
                    Thoughts on software development, programming languages, AI, and technology
                </p>
                <a
                    href="/rss.xml"
                    class="btn btn-ghost"
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"></path>
                        <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0A5 5 0 009 10a1 1 0 01-1-1z"></path>
                        <path d="M3 15a2 2 0 104 0 2 2 0 00-4 0z"></path>
                    </svg>
                    RSS Feed
                </a>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Blog Posts -->
    <section class="section">
        <div class="container container-sm">
            {posts.length === 0 ? (
                <div class="text-center py-16">
                    <div class="heading-3 mb-4 text-text-secondary">No Posts Yet</div>
                    <p class="body-normal text-text-tertiary">Check back soon for new content!</p>
                </div>
            ) : (
                <div class="space-y-8">
                    {posts.map((post) => (
                        <article class="border-b pb-8" style="border-color: var(--color-border-subtle);">
                            <a href={post.url} class="clickable-item">
                                <div class="flex items-center justify-between text-text-tertiary body-small mb-4">
                                    <time datetime={post.pubDate.toISOString()}>
                                        {post.formattedDate}
                                    </time>
                                    <span>{post.readingTime}</span>
                                </div>
                                
                                <h2 class="heading-2 mb-4 text-text-primary">
                                    {post.title}
                                </h2>
                                
                                <p class="body-normal text-text-secondary leading-relaxed mb-6">
                                    {post.excerpt}
                                </p>
                                
                                <div class="flex items-center gap-3">
                                    {post.tags.map((tag) => (
                                        <span class="body-small text-text-tertiary">#{tag}</span>
                                    ))}
                                </div>
                            </a>
                        </article>
                    ))}
                </div>
            )}
        </div>
    </section>

    <div class="divider"></div>

    <!-- Navigation -->
    <section class="section-sm">
        <div class="container container-md">
            <div class="text-center">
                <a href="/" class="btn btn-secondary link-arrow">
                    Back to Home
                </a>
            </div>
        </div>
    </section>
</Layout>
