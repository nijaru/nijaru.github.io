---
import GitHubIcon from "./icons/GitHubIcon.astro";
import XIcon from "./icons/XIcon.astro";

const pathname = Astro.url.pathname;

function isActive(path: string, currentPath: string): boolean {
  // Special case for blog - consider active for any path under /blog/
  if (path === '/blog' && (currentPath === '/blog' || currentPath.startsWith('/blog/'))) {
    return true;
  }
  // Direct path match
  return currentPath === path;
}

const navItems = [
  { href: '/', label: 'Home' },
  { href: '/blog', label: 'Blog' },
  { href: '/projects', label: 'Projects' },
];
---

<div class="fixed top-4 left-0 right-0 z-50 flex justify-center px-4 pointer-events-none">
  <nav class="glass-nav rounded-full px-6 py-3 flex items-center justify-between gap-8 transition-all duration-300 ease-out pointer-events-auto">
    <div class="flex items-center">
      <a href="/" class="text-lg font-bold flex items-center text-text-primary hover:text-white transition-colors">
        <span class="text-accent-primary">Nick</span>
        <span class="ml-1">Russo</span>
      </a>
    </div>

    <!-- Desktop Nav -->
    <div class="hidden md:flex items-center gap-1">
      {navItems.map(item => (
        <a
          href={item.href}
          class={`relative px-4 py-2 text-sm font-medium transition-colors rounded-full ${
            isActive(item.href, pathname) 
              ? 'text-white bg-white/10' 
              : 'text-text-secondary hover:text-white hover:bg-white/5'
          }`}
        >
          {item.label}
        </a>
      ))}
      
      <!-- Social Icons -->
      <div class="flex items-center gap-1 ml-2 pl-2 border-l border-white/10">
        <a
          href="https://github.com/nijaru"
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 text-text-secondary hover:text-white hover:bg-white/5 rounded-full transition-colors"
          aria-label="GitHub"
        >
          <GitHubIcon class="w-5 h-5" />
        </a>
        <a
          href="https://twitter.com/nijaru0x"
          target="_blank"
          rel="noopener noreferrer"
          class="p-2 text-text-secondary hover:text-white hover:bg-white/5 rounded-full transition-colors"
          aria-label="Twitter / X"
        >
          <XIcon class="w-4 h-4" />
        </a>
      </div>
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-button"
      class="md:hidden p-2 rounded-full text-text-secondary hover:text-white hover:bg-white/10 transition-colors"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Open main menu"
    >
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </nav>

  <!-- Mobile Menu Dropdown (Detached) -->
  <div 
    id="mobile-menu" 
    class="hidden absolute top-20 left-4 right-4 glass-nav rounded-2xl p-2 flex-col gap-1 transform origin-top transition-all duration-200 scale-95 opacity-0 pointer-events-auto"
    role="navigation"
  >
    {navItems.map(item => (
      <a 
        href={item.href} 
        class={`block px-4 py-3 text-base font-medium rounded-xl transition-colors ${
          isActive(item.href, pathname) 
            ? 'text-white bg-white/10' 
            : 'text-text-secondary hover:text-white hover:bg-white/5'
        }`}
      >
        {item.label}
      </a>
    ))}
  </div>
</div>

<style>
  .glass-nav {
    background: rgba(22, 23, 29, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Mobile menu animation classes */
  #mobile-menu.open {
    display: flex;
    transform: scale(100%);
    opacity: 1;
  }
</style>

<script>
  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const icon = button?.querySelector('svg path');

    if (!button || !menu) return;

    let isOpen = false;

    // Reset state on page load
    menu.classList.add('hidden');
    menu.classList.remove('open');
    button.setAttribute('aria-expanded', 'false');
    if (icon) {
      icon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16');
    }

    // Remove old listeners by cloning
    const newButton = button.cloneNode(true) as HTMLElement;
    button.parentNode?.replaceChild(newButton, button);
    const newIcon = newButton.querySelector('svg path');

    newButton.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen = !isOpen;

      if (isOpen) {
        menu.classList.remove('hidden');
        requestAnimationFrame(() => {
          menu.classList.add('open');
        });
      } else {
        menu.classList.remove('open');
        setTimeout(() => {
          menu.classList.add('hidden');
        }, 200);
      }

      newButton.setAttribute('aria-expanded', isOpen.toString());

      if (newIcon) {
        newIcon.setAttribute('d', isOpen ? 'M6 18L18 6M6 6l12 12' : 'M4 6h16M4 12h16M4 18h16');
      }
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (isOpen && !menu.contains(e.target as Node) && !newButton.contains(e.target as Node)) {
        isOpen = false;
        menu.classList.remove('open');
        setTimeout(() => {
          menu.classList.add('hidden');
        }, 200);

        newButton.setAttribute('aria-expanded', 'false');
        if (newIcon) {
          newIcon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16');
        }
      }
    });
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  } else {
    initMobileMenu();
  }

  // Run after view transitions
  document.addEventListener('astro:page-load', initMobileMenu);
</script>
