---
import Layout from "./Layout.astro";
import ReflectionText from "../components/ReflectionText.astro";
import TextGlow from "../components/TextGlow.astro";
import CodeBlock from "../components/CodeBlock.astro";
import HiringNotice from "../components/HiringNotice.astro";
import type { CollectionEntry } from 'astro:content';
import '../styles/markdown.css';

interface Props {
    post: CollectionEntry<'blog'>;
    prevPost?: CollectionEntry<'blog'> | null;
    nextPost?: CollectionEntry<'blog'> | null;
}

const { post, prevPost = null, nextPost = null } = Astro.props;
const { title, pubDate, description, author, tags, image } = post.data;

// Format the date
const formattedDate = pubDate.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});

// Calculate reading time
function calculateReadingTime(text) {
    const wordsPerMinute = 200;
    const words = text.trim().split(/\s+/).length;
    const minutes = Math.ceil(words / wordsPerMinute);
    return `${minutes} min read`;
}

const readingTime = calculateReadingTime(post.body);
---

<Layout title={title + " - Nick Russo"} description={description} ogType="article">
    <Fragment slot="head">
        <!-- Open Graph Article Metadata -->
        <meta property="article:published_time" content={pubDate.toISOString()} />
        <meta property="article:author" content={author} />
        {tags.map((tag) => <meta property="article:tag" content={tag} />)}

        <!-- Schema.org structured data for blog post -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                headline: title,
                description: description,
                image: image?.url,
                author: {
                    "@type": "Person",
                    name: author,
                },
                publisher: {
                    "@type": "Person",
                    name: author,
                },
                datePublished: pubDate.toISOString(),
                mainEntityOfPage: {
                    "@type": "WebPage",
                    "@id": Astro.url.href,
                },
                keywords: tags.join(", "),
            })}
        />
    </Fragment>
    <!-- Article Header -->
    <section class="section">
        <div class="container container-md">
            <div class="text-center mb-12">
                <h1 class="heading-1 mb-6">
                    <span class="text-accent-blue">{title}</span>
                </h1>
                
                <div class="flex items-center justify-center gap-4 mb-8 body-small text-text-tertiary">
                    <time datetime={pubDate.toISOString()}>
                        {formattedDate}
                    </time>
                    <span>â€¢</span>
                    <span>{readingTime}</span>
                </div>

                <div class="flex flex-wrap justify-center gap-2">
                    {
                        tags.map((tag) => (
                            <span class="badge badge-primary">
                                {tag}
                            </span>
                        ))
                    }
                </div>
            </div>

            <!-- Article Content -->
            <div class="glass-card p-12">
                <article class="blog-content prose prose-invert max-w-none">
                    <slot />
                    <CodeBlock />
                </article>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- Hiring Notice -->
    <section class="section-sm">
        <div class="container container-md">
            <HiringNotice />
        </div>
    </section>

    <div class="divider"></div>

    <!-- Post Navigation -->
    {(prevPost || nextPost) && (
        <section class="section-sm">
            <div class="container container-md">
                <div class="flex flex-col gap-6">
                    {prevPost && (
                        <a
                            href={`/blog/${prevPost.slug}`}
                            class="glass-card p-6 hover:border-color-border-default transition-all group flex items-center gap-6"
                        >
                            <div class="flex-shrink-0 text-text-tertiary group-hover:text-accent-primary transition-colors">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="body-small text-text-tertiary mb-2">Previous Post</div>
                                <h3 class="heading-3 mb-2 text-text-primary group-hover:text-accent-primary transition-colors">
                                    {prevPost.data.title}
                                </h3>
                                <p class="body-small text-text-secondary line-clamp-2">
                                    {prevPost.data.description}
                                </p>
                            </div>
                        </a>
                    )}

                    {nextPost && (
                        <a
                            href={`/blog/${nextPost.slug}`}
                            class="glass-card p-6 hover:border-color-border-default transition-all group flex items-center gap-6"
                        >
                            <div class="flex-shrink-0 w-[40px]"></div>
                            <div class="flex-1 min-w-0">
                                <div class="body-small text-text-tertiary mb-2">Next Post</div>
                                <h3 class="heading-3 mb-2 text-text-primary group-hover:text-accent-primary transition-colors">
                                    {nextPost.data.title}
                                </h3>
                                <p class="body-small text-text-secondary line-clamp-2">
                                    {nextPost.data.description}
                                </p>
                            </div>
                            <div class="flex-shrink-0 text-text-tertiary group-hover:text-accent-primary transition-colors">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </a>
                    )}
                </div>
            </div>
        </section>
    )}

    {(prevPost || nextPost) && <div class="divider"></div>}

    <!-- Navigation -->
    <section class="section-sm">
        <div class="container container-md">
            <div class="text-center">
                <a href="/blog" class="btn btn-secondary link-arrow">
                    Back to Blog
                </a>
            </div>
        </div>
    </section>
</Layout>